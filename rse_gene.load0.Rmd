---
title: "rse_gene_all"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup libraries

```{r}
library("SummarizedExperiment")
library("dplyr")
```

## load latest rse_gene object

```{r}
load("data/RNAseq_Collection_postQC_n5536_11dataset_2021-01-07_geneRSE.Rdata")
g_cd <- as.data.frame(colData(rse_gene))
g_rd <- as.data.frame(rowData(rse_gene))
g_a <- assay(rse_gene)
```


### Connect to database

```{r}
library('RPostgreSQL')

dbp <- read.delim(".pgpass", sep=":", header=TRUE)
pg_db <- "rse"
pg_user <- subset(dbp, database=="rse")[[1,4]]
pg_pass <- subset(dbp, database=="rse")[[1,5]]

pg <- dbDriver("PostgreSQL")

con <- dbConnect(pg, dbname=pg_db, user=pg_user, password=pg_pass, host="gdebsrv")
#show tables
dbListTables(con)
```
### Loading the `subjects` table from rse_gene:

```{r}
#select columns of interest
sd <- g_cd[ c("BrNum", "Age", "Sex", "Race", "Dx") ]
#convert column names to lowercase
colnames(sd) <- tolower(colnames(sd))
#remove row names
rownames(sd) <- NULL
## remove duplicate BrNum entries, keep only the last one in each group

sdf <- sd[!duplicated(sd$brnum, fromLast=T),]

#---
#append the data!
dbWriteTable(con, name="subjects", value=sdf, append=TRUE, row.names=FALSE)

```
### Loading the samples and exp_RNASeq tables
```{r}
## -- update datasets table
dsfreq <- as.data.frame(table(g_cd$Dataset, dnn=c("name")))
colnames(dsfreq) <- tolower(colnames(dsfreq))
dbWriteTable(con, name="datasets_tmp", value=dsfreq, append=FALSE, row.names=FALSE, temporary=T)
qry <- "INSERT into datasets (name)
  SELECT t.name from datasets_tmp t where 
    NOT EXISTS( SELECT * from datasets d where d.name = t.name )"
dbGetQuery(con, qry)


## now load the display and subjects tables to get the ids
ds <- dbGetQuery(con, 'select * from datasets')
subj <- dbGetQuery(con, 'select * from subjects')

##
smp <- g_cd[ c("BrNum", "Dataset", "SAMPLE_ID", "RNum", "RIN", "Region", 
    "numReads", "numMapped","numUnmapped", "mitoMapped", "totalMapped",
    "overallMapRate", "concordMapRate", "mitoRate", "rRNA_rate", "totalAssignedGene", "bamFile") ]
colnames(smp) <- tolower(colnames(smp))
#strip RNum and convert it to numeric
smp$rnum <- substring(smp$rnum, 2)
smp$rnum <- as.numeric(smp$rnum)

## adding dataset_id from matching entries in ds:
smp$dataset_id <- ds$id[ match(smp$dataset, ds$name) ]
## adding subj_id
smp$subj_id <- subj$id[ match(smp$brnum, subj$brnum) ]

## load samples table through a temporary table
#for simplicity, add a num column for the samples table
smp$num <- smp$rnum

## 
dbWriteTable(con, name="samples_tmp", value=smp[c("num", "subj_id", "region")], append=FALSE, row.names=FALSE, temporary=T)

dbGetQuery(con, "CREATE INDEX idx_samplestmp_num ON samples_tmp (num);")

qry <- "INSERT into samples (num, subj_id, region)
  SELECT num, subj_id, cast(region as varchar) from samples_tmp t where 
    NOT EXISTS( SELECT * from samples s where s.num = t.num 
                and s.subj_id = t.subj_id and text(s.region) = t.region)"

dbGetQuery(con, qry)

```

