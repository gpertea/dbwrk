---
title: "dbload_preprocessed"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r cars}
library(dplyr)
library(SummarizedExperiment)
library(readxl) #to load Excel files
```


```{r}
#objs <- load("data/dlpfc_polyA_brainseq_phase1_hg38_rseGene_merged_n732.rda")
#cd <- as.data.frame(colData(rse_gene))
objs <- load("data/all_rse_gene/updated_rse_gene_DLPFC_polyA_BrainSeq_Phase1_LIBD_n959.Rdata")
grse <- rse_gene
gcd <- as.data.frame(colData(grse))
grd <- as.data.frame(rowData(grse))
ga <- as.data.frame(assay(grse))
```

```{r}
bspxl <-  as.data.frame(read_excel("All-PhaseI-II-III-IV-V-samples_03_14_2019.xlsx"))
colnames(bspxl) <- tolower(colnames(bspxl))
colnames(bspxl)[1] <- "brint"
colnames(bspxl) <- gsub("mpfc_phaseiv-v_", "mpfc_phase45_", colnames(bspxl))
colnames(bspxl) <- gsub("_phasei_", "_phase1_", colnames(bspxl))
colnames(bspxl) <- gsub("_phaseii_", "_phase2_", colnames(bspxl))
colnames(bspxl) <- gsub("_phaseiii_", "_phase3_", colnames(bspxl))

bspxl$brint=as.integer(bspxl$brnum)
bspAll <- subset(bspxl, !is.na(dlpfc_phase1_rnum), select=c("brint", "dlpfc_phase1_rnum", "dlpfc_phase1_protocol", "dlpfc_phase1_rin"))
colnames(bspAll)=c("brint", "rnum", "protocol", "rin")
bspAll$region="DLPFC"
bspAll$dataset="DLPFC_Phase1"

bspsel <- subset(bspxl, !is.na(dlpfc_phase2_rnum), select=c("brint", "dlpfc_phase2_rnum", 
                                                          "dlpfc_phase2_protocol", "dlpfc_phase2_rin"))
colnames(bspsel)=c("brint", "rnum", "protocol", "rin")
bspsel$region="DLPFC"
bspsel$dataset="DLPFC_Phase2"
bspAll <- rbind(bspAll, bspsel)

bspsel <- subset(bspxl, !is.na(hippo_phase2_rnum), select=c("brint", "hippo_phase2_rnum", 
                                                            "hippo_phase2_protocol", "hippo_phase2_rin"))
colnames(bspsel)=c("brint", "rnum", "protocol", "rin")
bspsel$region="HIPPO"
bspsel$dataset="HIPPO_Phase2"
bspAll <- rbind(bspAll, bspsel)

bspsel <- subset(bspxl, !is.na(caudate_phase3_rnum), select=c("brint", "caudate_phase3_rnum", 
                                                              "caudate_phase3_protocol", "caudate_phase3_rin"))
colnames(bspsel)=c("brint", "rnum", "protocol", "rin")
bspsel$region="Caudate"
bspsel$dataset="Caudate_Phase3"
bspAll <- rbind(bspAll, bspsel)

bspsel <- subset(bspxl, !is.na(mpfc_phase45_rnum), select=c("brint", "mpfc_phase45_rnum", "mpfc_phase45_protocol", "mpfc_phase45_rin"))
colnames(bspsel)=c("brint", "rnum", "protocol", "rin")
bspsel$region="mPFC"
bspsel$dataset="mPFC_Phase45"
bspAll <- rbind(bspAll, bspsel)
bspAll$rnum <- paste0("R",bspAll$rnum)
#write.table(bspAll, file="All-PhaseI-II-III-IV-V-samples_03_14_2019.tab", quote = FALSE, row.names=FALSE, sep="\t")

```


```{r}
rb <- read.csv("data/2017_RNum_BrNum.csv")
colnames(rb) <- tolower(colnames(rb))
rb$brint <- as.integer(gsub("Br","", rb$BrNum))

#rm <- read.csv("data/all_rse_gene/updated_read_and_alignment_metrics_DLPFC_polyA_BrainSeq_Phase1_LIBD.csv")
cdta <- gcd[c("SAMPLE_ID", "trimmed", "numReads", "numMapped", "numUnmapped", "totalMapped", "overallMapRate", "concordMapRate", "mitoMapped", "mitoRate", "rRNA_rate", "totalAssignedGene","bamFile")]
```

merge colData rows in cdta by RNum
```{r}
cdta$rnum <- gsub("_[^_]\\w+$", "", cdta$SAMPLE_ID, perl = TRUE)
xdta <- cdta %>% group_by(rnum) %>% summarize ( SAMPLE_ID = paste(SAMPLE_ID, collapse=";"), trimmed=(sum(trimmed)>0), 
                        numReads_t=sum(numReads), numMapped_t=sum(numMapped), numUnmapped=sum(numUnmapped), 
                        totalMapped=sum(totalMapped), overallMapRate=sum(overallMapRate*numReads)/sum(numReads),
                        concordMapRate=sum(concordMapRate*numReads)/sum(numReads), mitoMapped=sum(mitoMapped),
                        mitoRate=sum(mitoRate*numMapped)/sum(numMapped), rRNA_rate=sum(rRNA_rate*numMapped)/sum(numMapped),
                        totalAssignedGene=sum(totalAssignedGene*numMapped)/sum(numMapped),
                        bamFile=paste(bamFile, collapse=";") )
colnames(xdta) <- gsub("_t$", "", colnames(xdta), perl=TRUE)

truncSmpID <- function(x) {
  mp <- regexpr(';',x, fixed=TRUE)
  if (mp[[1]]>-1) x=substr(x,1,mp[[1]]-1)
  mp <- gregexpr('_',x, fixed=TRUE)
  if (length(mp[[1]])<2) return(x)
  return(substr(x,1,mp[[1]][2]-1))
}
xdta$SAMPLE_ID <- sapply(xdta$SAMPLE_ID, truncSmpID)
colnames(xdta) [colnames(xdta) == "SAMPLE_ID"] <- "sample_id"
nd <- sum( duplicated(xdta$sample_id) )
if (nd>0)
  stop("Error: duplicates found in xdta$sample_id after truncation")
```

### Connect to database

```{r}
library('RPostgreSQL')

dbp <- read.delim(".pgpass", sep=":", header=TRUE)
pg_db <- "rse"
pg_user <- subset(dbp, database=="rse")[[1,4]]
pg_pass <- subset(dbp, database=="rse")[[1,5]]

pg <- dbDriver("PostgreSQL")

con <- dbConnect(pg, dbname=pg_db, user=pg_user, password=pg_pass, host="gdebsrv")
#get a dataframe with subj data
dbsubj <- dbGetQuery(con, "select * from subjects")
#get a dataframe with subj data to RNum mapping

rnum2brnum <- dbGetQuery(con, "SELECT t.name as dataset, s.name as rnum, sample_id, brnum, brint, 'P'||trim(to_char(p.id, '00000')) as sample, dx, sex, race, age, pmi
 FROM subjects p, dx d, samples s, exp_rnaseq x, datasets t WHERE s.subj_id=p.id AND x.s_id=s.id
 AND d.id=p.dx_id AND t.id=x.dataset_id
 ORDER BY 2")
```


```{r}
##TODO fetch the RIN from the bspAll table for all the RNums in xdta that are not in `samples` table

missbr <- nrow(anti_join(rb, dbsubj, by="brint"))
if (missbr>0) {
  stop("BrNum entries are missing from database, check anti_join(rb, dbsubj, by='brint')!")
}
msid <- anti_join(xdta, rnum2brnum, by="sample_id")
if (nrow(msid)>0) {
  message("RNums missing from database: ",nrow(msid))
  msid$brnum <- rb$brnum[match(msid$rnum, rb$rnum)]
  rb$region <- gsub("^([^_]+)_\\w+", "\\1", rb$dataset)
  table(rb$region)
}
```


